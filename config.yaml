# SmartCI 配置文件示例
# 支持Docker CI/CD流水线、Bash任务调度、OAuth授权和Webhook监听

# 服务器配置
server:
  host: "localhost"
  port: 8081
  # 可选：认证密钥
  auth_token: ""
  # 可选：TLS配置
  tls:
    enabled: false
    cert_file: ""
    key_file: ""

# OAuth配置
oauth:
  # GitHub OAuth配置
  - name: "github"
    client_id: "${GITHUB_CLIENT_ID}"
    client_secret: "${GITHUB_CLIENT_SECRET}"
    redirect_url: "http://localhost:8080/oauth/callback?provider=github"
    scopes:
      - "repo"
      - "read:user"
      - "admin:repo_hook"

# Webhook配置
webhooks:
  # GitHub push事件webhook
  - name: "github-push-deploy"
    path: "/webhook/github/push"
    provider: "github"
    secret: "${GITHUB_WEBHOOK_SECRET}"
    events:
      - "push"
      - "pull_request"
    filters:
      branches:
        - "main"
        - "develop"
      actions:
        - "opened"
        - "synchronize"
    actions:
      # 执行部署任务
      - type: "task"
        task: "deploy-app"
      # 执行测试命令
      - type: "command"
        command: "echo 'Running tests for ${GITHUB_REF}' && npm test"
        working_dir: "/home/engine/project"
        timeout: 600

  # GitHub release事件webhook
  - name: "github-release"
    path: "/webhook/github/release"
    provider: "github"
    secret: "${GITHUB_WEBHOOK_SECRET}"
    events:
      - "release"
    filters:
      actions:
        - "published"
    actions:
      # 执行发布脚本
      - type: "script"
        script: "./scripts/release.sh"
        working_dir: "/home/engine/project"
        timeout: 1800
        env:
          RELEASE_TYPE: "production"

  # 通用webhook（无认证）
  - name: "manual-trigger"
    path: "/webhook/manual"
    events:
      - "*"
    actions:
      - type: "task"
        task: "backup-database"

# Bash任务调度配置
bash_tasks:
  - name: "hotel-be-e2e-test"
    description: "定时hotel-be e2e测试"
    schedule: "*/5 * * * *"  # 每10分钟执行一次
    command: |
      echo "hotel-be e2e 测试开始"
      bash ./hotel-be-e2e-test.sh feat/auto-e2e-test
      echo "hotel-be e2e 测试结束"
    working_dir: "."
    timeout: 1800  # 30分钟超时
    auto_analyze: true
